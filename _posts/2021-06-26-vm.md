---
title: "virsh簡單入門"
date: 2021-06-26T17:23:22-00:00
categories:
  - VM
tags:
  - vm
  - virsh
  - qemu
  - kvm
---

## 開頭閒聊

最近因為工作關係需要接觸到 vm
很意外在這個意外在這個 cloud native 且 container 技術大流行的時代
還會有機會接觸到 vm 相關的需求
不過相信很多企業或是公家機關內部為了保證資訊安全性 仍然會採用 VM 的解決方案

我上次使用 vm 以及對 vm 的印象就是 VMware 或是 VirtualBox 這類的 GUI 商用軟體
這次可以很難得的稍微窺探一下 vm 底層的工具

## 安裝

這部分以 Ubuntu 20.04 LST 版本做示範

1. 使用檢查環境

輸入

```sh
kvm-ok
```

這個指令可以檢查目前的環境是否支援 kvm 硬體加速技術  
假如沒有打開的話可以去 BIOS 打開  
不過假如環境是在 AWS 之類的雲端主機的話可能就沒辦法了  
目前支援 nested virtualization 的平台應該不多  
不過就算你的機器不支援 kvm 也沒關係  
你還是能跑 vm 只是速度會相對慢一點

2. 安裝必要套件

```sh
sudo apt update
sudo apt install qemu qemu-kvm libvirt-daemon-system virt-manager
sudo adduser $USER libvirt
```

## virsh

virsh 是一套建立在 Xen, QEMU, KVM, LXC...等等虛擬技術軟體上的整合工具  
這邊介紹一些 virsh 的基礎用法

首先任何工具的第一課 如何叫出使用說明

```sh
virsh help
```

列出所有虛擬機

```sh
virsh list
```

啟動虛擬機

```sh
virsh start <Name>
```

關閉虛擬機

```sh
virsh shutdown <Name>
```

重開機虛擬機

```sh
virsh reboot <Name>
```

關閉虛擬機

```sh
virsh destroy <Name>
```

進入虛擬機環境

```sh
virsh console <Name>
```

修改虛擬機設定

```sh
virsh edit <Name>
```

暫停虛擬機

```sh
virsh suspend <Name>
```

回覆虛擬機

```sh
virsh resume <Name>
```

## 從 image 檔案啟動虛擬機

一個開啟 Ubuntu 18.04 VM 的簡單範例

```sh
wget http://cdimage.ubuntu.com/ubuntu-server/bionic/daily/current/bionic-server-amd64.iso

sudo qemu-img create -f qcow2 ubuntu1804.qcow2 2G

sudo virt-install \
--name ubuntu18 \
--ram=1024 \
--vcpus=2 \
--os-type=linux \
--cdrom bionic-server-amd64.iso\
--graphics none \
--disk path=ubuntu1804.qcow2
```

這會啟動一個叫 ubuntu18 的 vm 以及 2g 的 qcow2 ubuntu1804.qcow2 虛擬硬碟

你可以用`virsh list`來看 vm 的運作情況
